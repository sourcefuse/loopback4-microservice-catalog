# @sourceloop/cache

This package provides a mixin which works with redis to cache GET request responses.

## Installation

```
npm i @sourceloop/cache
```

This package has loopback-connector-kv-redis as a peer dependency.

## Usage

You simply need to extend your repository with the CacheRespositoryMixin provided. While extending you can provide the following options

- prefix (mandatory) - every cached entry is required to have a prefix in its key. The key generated by the mixin is of the sort - 'prefix_id_filter_options'
- ttl (optional) - this is the maximum time in milliseconds for which data will remain cached in redis. In other words this can be called the amount of time for which stale data is acceptable. Default value is 60000.
- scanCount (optional) - while clearing the cache using clearCache() function provided, all the keys beginning with the prefix are searched for using the SCAN command. This command can take an additoinal paramter COUNT (here refered to as scanCount) - this is the number of elements returned/deleted at a time. Default value is 50.

If you want to delete all cache entries, you can use the clearCache() function provided to do this. This will delete all cache entries with the given prefix. It also returns the number of matching entries deleted from cache.

### Configuring Datasource

The redis datasource can be bound to any key. However, it is required that you inject the datasource into the repository on which mixin is to be applied. For this, you must provide redisDataSource as variable name for the injected datasource.

An example of using the cache mixin:

```
export class ProductRepository extends CacheRespositoryMixin<
  Product,
  typeof Product.prototype.id,
  ProductRelations,
  Constructor<
    DefaultCrudRepository<
      Product,
      typeof Product.prototype.id,
      ProductRelations
    >
  >
>(DefaultCrudRepository, {prefix: 'product', ttl: 50000}) {
  redisDataSource: RedisDataSource;
  constructor(
    @inject('datasources.expt') dataSource: ExptDataSource,
    @inject(`datasources.CacheDB`)
    public cacheDataSource: RedisDataSource,
  ) {
    super(Product, dataSource);
  }
}
```
